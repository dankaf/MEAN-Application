"use strict";angular.module("jackrabbitsgroup.angular-infinitescroll",[]).directive("jrgInfinitescroll",["$timeout","jrgInfinitescrollData",function($timeout,jrgInfinitescrollData){return{restrict:"A",transclude:!0,scope:{items:"=",itemsView:"=",opts:"=",loadMore:"&?"},replace:!0,template:function(element,attrs){var defaults={pageSize:10,scrollLoad:"0",loadMorePageSize:20,pageScroll:0,scrollBuffer:50,scrollBufferPercent:33,noStopLoadMore:0,negativeLoad:0,animateLoad:0,animateScrollDuration:1e3,itemHeight:0,animateAfterItems:0,animateAfterDuration:1e3,noMoreResultsText:"No More Results!",minItemsToShow:0};for(var xx in defaults)void 0===attrs[xx]&&(attrs[xx]=defaults[xx]);for(var attrsToInt=["pageSize","loadMorePageSize","scrollLoad","scrollBuffer","pageScroll","noStopLoadMore","negativeLoad","animateLoad","animateScrollDuration","itemHeight","animateAfterItems","animateAfterDuration","minItemsToShow"],ii=0;ii<attrsToInt.length;ii++)attrs[attrsToInt[ii]]=parseInt(attrs[attrsToInt[ii]],10);attrs.loadMorePageSize<attrs.pageSize&&(attrs.loadMorePageSize=attrs.pageSize),attrs.animateAfterItems>=Math.floor(attrs.pageSize/2)&&(attrs.animateAfterItems=Math.floor(attrs.pageSize/4)),void 0===attrs.id&&(attrs.id="jrgInfinitescroll"+Math.random().toString(36).substring(7));var id1=attrs.id;attrs.ids={input:id1+"Input",contentBottom:id1+"ContentBottom",inputBelow:id1+"InputBelow",scrollContent:id1+"ScrollContent"};var html="<div class='jrg-infinitescroll'><div class='jrg-infinitescroll-top'><div ng-hide='!trigs.scrollbarChecked || trigs.loading || (noMoreLoadMoreItems.prev && opts.cursors.itemsView.start <=opts.cursors.items.start) || (opts.cursors.itemsView.start <=0 && !negativeLoad) || (scrollLoad && hasScrollbar)' class='jrg-infinitescroll-more' ng-click='loadMoreDir({\"prev\":true})'>Load More</div></div><div id='"+attrs.ids.scrollContent+"' class='jrg-infinitescroll-content' ng-transclude></div><div id='"+attrs.ids.contentBottom+"'><div ng-hide='!trigs.scrollbarChecked || trigs.loading || (noMoreLoadMoreItems.next && opts.cursors.itemsView.end >=opts.cursors.items.end) || (scrollLoad && hasScrollbar)' class='jrg-infinitescroll-more' ng-click='loadMoreDir({})'>Load More</div><div ng-show='trigs.scrollbarChecked && noMoreLoadMoreItems.next && opts.cursors.items.end <= opts.cursors.itemsView.end' class='jrg-infinitescroll-no-more'>"+attrs.noMoreResultsText+"</div></div></div>";return html},controller:function($scope,$element,$attrs){function init(){$scope.trigs.loading=!0,$scope.trigs.scrollbarChecked=!1,$scope.page=Math.floor($scope.opts.cursors.itemsView.current/$attrs.pageSize),setItemsViewCursor({}),setItems({}),$scope.items.length<2*$attrs.pageSize&&($scope.trigs.loading=!0,$scope.loadMoreDir({}))}function resetItems(){jrgInfinitescrollData.exists($attrs.id,{})&&($scope.opts.cursors.items.start=0,$scope.opts.cursors.items.end=$scope.items.length,$scope.opts.cursors.itemsView.current=0,$scope.opts.cursors.negative=0,$scope.trigs.loading=!0,$scope.trigs.scrollbarChecked=!1,$scope.noMoreLoadMoreItems.prev=!1,$scope.noMoreLoadMoreItems.next=!1,timeoutInfo.scrolling.trig=!1,triggers.skipWatch=!1,jrgInfinitescrollData.data[$attrs.id].scrollPos=-1,checkForScrollBar({}),$attrs.pageScroll?window.scrollTo(0,0):document.getElementById(scrollId).scrollTop=0)}function setItems(params){var cursorsSave;if(jrgInfinitescrollData.exists($attrs.id,{})){var diff,height1,ppSend={};if($attrs.itemHeight&&(height1=$attrs.itemHeight,cursorsSave={start:$scope.opts.cursors.itemsView.start,end:$scope.opts.cursors.itemsView.end}),void 0!==params.cursorViewStart?($scope.opts.cursors.itemsView.start=params.cursorViewStart,$scope.opts.cursors.itemsView.end=$scope.opts.cursors.itemsView.start+$attrs.pageSize,$scope.opts.cursors.itemsView.end>$scope.items.length&&($scope.opts.cursors.itemsView.end=$scope.items.length),$scope.opts.cursors.itemsView.end-$scope.opts.cursors.itemsView.start<=$attrs.minItemsToShow&&($scope.opts.cursors.itemsView.start=$scope.opts.cursors.itemsView.end-$attrs.minItemsToShow,$scope.opts.cursors.itemsView.start<0&&($scope.opts.cursors.itemsView.start=0)),$scope.page=Math.ceil($scope.opts.cursors.itemsView.start/$attrs.pageSize)):($scope.opts.cursors.itemsView.end=$scope.page*$attrs.pageSize+$attrs.pageSize,setItemsViewCursor({})),$scope.itemsView=$scope.items.slice($scope.opts.cursors.itemsView.start,$scope.opts.cursors.itemsView.end),$attrs.itemHeight){params.prev?(ppSend.prev=!0,diff=cursorsSave.start-$scope.opts.cursors.itemsView.start):(ppSend.prev=!1,diff=$scope.opts.cursors.itemsView.end-cursorsSave.end);var diffHeight=diff*height1;0>diffHeight&&(diffHeight=-1*diffHeight),ppSend.diffHeight=diffHeight}$scope.itemsView.length>=$attrs.pageSize&&scrollToMiddle(ppSend),checkForScrollBar({}),$scope.trigs.loading=!1}}function setItemsViewCursor(){var end=$scope.page*$attrs.pageSize+$attrs.pageSize;end>$scope.items.length&&(end=$scope.items.length),$scope.opts.cursors.itemsView.end=end;var start=$scope.page*$attrs.pageSize-$attrs.pageSize;0>start&&(start=0),$scope.opts.cursors.itemsView.start=start}function scrollToMiddle(params){if(jrgInfinitescrollData.exists($attrs.id,{})){var scrollPos,scrollHeight,viewportHeight,middle,newMiddle;if($attrs.pageScroll)scrollPos=$(window).scrollTop(),scrollHeight=$(document).height(),viewportHeight=$(window).height(),middle=Math.floor(scrollHeight/2-viewportHeight/2),params.diffHeight&&(middle=params.prev?params.diffHeight:scrollHeight-params.diffHeight-viewportHeight),void 0!==params.alreadyTimedOut&&params.alreadyTimedOut||!(middle>scrollHeight||scrollHeight<$attrs.itemHeight*$attrs.pageSize*2)?($attrs.animateScroll?scrollAnimate(!1,middle,{duration:$attrs.animateScrollDuration},{}):window.scrollTo(0,middle),$attrs.animateAfterItems&&(newMiddle=params.prev?middle-$attrs.itemHeight*$attrs.animateAfterItems:middle+$attrs.itemHeight*$attrs.animateAfterItems,scrollAnimate(!1,newMiddle,{duration:$attrs.animateAfterDuration},{}))):$timeout(function(){params.alreadyTimedOut=!0,scrollToMiddle(params)},100);else{var ele=document.getElementById(scrollId);scrollPos=ele.scrollTop,scrollHeight=ele.scrollHeight,viewportHeight=ele.clientHeight,middle=Math.floor(scrollHeight/2-viewportHeight/2),params.diffHeight&&(middle=params.prev?params.diffHeight:scrollHeight-params.diffHeight-viewportHeight),void 0!==params.alreadyTimedOut&&params.alreadyTimedOut||!(middle>scrollHeight||scrollHeight<$attrs.itemHeight*$attrs.pageSize*2)?($attrs.animateScroll?scrollAnimate("#"+scrollId,middle,{duration:$attrs.animateScrollDuration},{}):document.getElementById(scrollId).scrollTop=middle,$attrs.animateAfterItems&&(newMiddle=params.prev?middle-$attrs.itemHeight*$attrs.animateAfterItems:middle+$attrs.itemHeight*$attrs.animateAfterItems,scrollAnimate("#"+scrollId,newMiddle,{duration:$attrs.animateAfterDuration},{}))):$timeout(function(){params.alreadyTimedOut=!0,scrollToMiddle(params)},100)}}}function scrollAnimate(scrollEle,scrollTo,scrollParams){var defaults={queue:!1};scrollParams=angular.extend(defaults,scrollParams),scrollEle||(scrollEle="body, html"),$(scrollEle).animate({scrollTop:scrollTo+"px"},scrollParams)}function changePage(params){params.prev?$scope.page--:$scope.page++,setItems(params)}function getMoreItems(params){var loadPageSize,cursor;if(void 0!==$scope.loadMore&&void 0!==$scope.loadMore()&&"function"==typeof $scope.loadMore()){var ppTemp={};params.prev?(ppTemp.prev=!0,($scope.opts.cursors.items.start>0||$scope.negativeLoad)&&!$scope.noMoreLoadMoreItems.prev&&(triggers.skipWatch=!0,loadPageSize=$attrs.loadMorePageSize,cursor=$scope.opts.cursors.items.start+$scope.opts.cursors.negative-loadPageSize,$scope.loadMore()({cursor:cursor,loadMorePageSize:loadPageSize,searchText:""},function(results,ppCustom){addLoadMoreItems(results,ppCustom,ppTemp)}))):(ppTemp.next=!0,$scope.noMoreLoadMoreItems.next||(triggers.skipWatch=!0,loadPageSize=$attrs.loadMorePageSize,cursor=$scope.opts.cursors.items.end,$scope.loadMore()({cursor:cursor,loadMorePageSize:loadPageSize,searchText:""},function(results,ppCustom){addLoadMoreItems(results,ppCustom,ppTemp)})))}}function addLoadMoreItems(results,ppCustom,params){if(results.length>0)if(params.prev)$scope.items=results.concat($scope.items),$scope.page+=Math.ceil(results.length/$attrs.pageSize),$scope.opts.cursors.items.start-=results.length,$scope.opts.cursors.items.start<0&&($scope.opts.cursors.negative-=-1*$scope.opts.cursors.items.start,$scope.opts.cursors.items.end+=-1*$scope.opts.cursors.items.start,$scope.opts.cursors.items.start=0),changePage(params);else if($scope.items=$scope.items.concat(results),$scope.opts.cursors.items.end+=results.length,void 0!==ppCustom&&void 0!==ppCustom.numPrevItems&&ppCustom.numPrevItems){$scope.opts.cursors.negative-=ppCustom.numPrevItems;var ppSend={cursorViewStart:ppCustom.numPrevItems};setItems(ppSend)}else changePage(params);else(params.prev&&$scope.opts.cursors.items.start<$scope.opts.cursors.itemsView.start||params.next&&$scope.opts.cursors.items.end>$scope.opts.cursors.itemsView.end)&&changePage(params);$attrs.noStopLoadMore||(results.length<$attrs.loadMorePageSize||void 0!==params.loadPageSize&&results.length<params.loadPageSize)&&(params.prev?$scope.noMoreLoadMoreItems.prev=!0:($scope.noMoreLoadMoreItems.next=!0,void 0!==ppCustom&&void 0!==ppCustom.numPrevItems&&ppCustom.numPrevItems&&($scope.noMoreLoadMoreItems.prev=!0))),$timeout(function(){triggers.skipWatch=!1},100)}function checkForScrollBar(){var scrollHeight,viewportHeight;$scope.scrollLoad?$timeout(function(){if($attrs.pageScroll)scrollHeight=$(document).height(),viewportHeight=$(window).height(),$scope.hasScrollbar=scrollHeight>viewportHeight?!0:!1;else{var ele=document.getElementById(scrollId);scrollHeight=ele.scrollHeight,viewportHeight=ele.clientHeight,$scope.hasScrollbar=scrollHeight>viewportHeight?!0:!1}$scope.trigs.scrollbarChecked=!0},100):$scope.trigs.scrollbarChecked=!0}var defaultsOpts={cursors:{items:{start:0,end:$scope.items.length},itemsView:{current:0}},scrollId:!1};void 0===$scope.opts&&($scope.opts={});for(var xx in defaultsOpts)void 0===$scope.opts[xx]&&($scope.opts[xx]=defaultsOpts[xx]);var scrollId=$attrs.ids.scrollContent;if($scope.opts.scrollId&&(scrollId=$scope.opts.scrollId),$scope.negativeLoad=$attrs.negativeLoad,$scope.opts.cursors.negative=0,$scope.trigs={loading:!0,scrollbarChecked:!1},$scope.noMoreLoadMoreItems={prev:!1,next:!1},$scope.scrollLoad=$attrs.scrollLoad,$scope.scrollLoad){if(!$attrs.pageScroll){var ele1=document.getElementById(scrollId),eleAng=angular.element(ele1),height1=eleAng.css("height"),overflow1=eleAng.css("overflow");height1&&overflow1||eleAng.addClass("jrg-infinite-content-scroll")}$scope.hasScrollbar=!1}var timeoutInfo={scrolling:{trig:!1,delay:750}},triggers={skipWatch:!1};jrgInfinitescrollData.initInst($attrs.id,{attrs:$attrs,timeoutInfo:timeoutInfo}),$attrs.scrollLoad&&$timeout(function(){jrgInfinitescrollData.exists($attrs.id,{})&&($attrs.pageScroll?jrgInfinitescrollData.addScrollEvt($attrs.id,{attrs:$attrs,timeoutInfo:timeoutInfo,callback:function(){$timeout.cancel(timeoutInfo.scrolling.trig),timeoutInfo.scrolling.trig=$timeout(function(){var buffer=$attrs.scrollBuffer,scrollPos=$(window).scrollTop(),oldScrollPos=jrgInfinitescrollData.data[$attrs.id].scrollPos;if(jrgInfinitescrollData.data[$attrs.id].scrollPos=scrollPos,-1!==oldScrollPos){var scrollHeight=$(document).height(),viewportHeight=$(window).height(),percentTop=scrollPos/scrollHeight*100,percentBottom=(scrollPos+viewportHeight)/scrollHeight*100;$scope.scrollInfo={scrollPos:scrollPos,scrollHeight:scrollHeight,viewportHeight:viewportHeight,diff:scrollHeight-viewportHeight-buffer,percentTop:percentTop,percentBottom:percentBottom},scrollPos>5&&scrollPos>=scrollHeight-viewportHeight-buffer&&$scope.loadMoreDir({noDelay:!0,next:!0}),buffer>=scrollPos&&$scope.loadMoreDir({noDelay:!0,prev:!0})}},timeoutInfo.scrolling.delay)}}):document.getElementById(scrollId).onscroll=function(){$timeout.cancel(timeoutInfo.scrolling.trig),timeoutInfo.scrolling.trig=$timeout(function(){var buffer=$attrs.scrollBuffer,ele=document.getElementById(scrollId),scrollPos=ele.scrollTop,scrollHeight=ele.scrollHeight,viewportHeight=ele.clientHeight;scrollPos>=scrollHeight-viewportHeight-buffer&&$scope.loadMoreDir({noDelay:!0,next:!0}),buffer>=scrollPos&&$scope.loadMoreDir({noDelay:!0,prev:!0})},timeoutInfo.scrolling.delay)})},750),$scope.$watch("items",function(newVal,oldVal){angular.equals(oldVal,newVal)||triggers.skipWatch||(resetItems({}),init({}))}),$scope.$on("jrgInfinitescrollReInit",function(evt,params){void 0!==$scope.opts.instId&&void 0!==params.instId&&$scope.opts.instId==params.instId&&($scope.items.length>0?$scope.items=[]:(resetItems({}),init({})))}),$scope.$on("jrgInfinitescrollRefresh",function(evt,params){void 0!==$scope.opts.instId&&void 0!==params.instId&&$scope.opts.instId==params.instId&&(resetItems({}),init({}))}),$scope.$on("jrgInfinitescrollLoadMore",function(evt,params){if(void 0!==$scope.opts.instId&&void 0!==params.instId&&$scope.opts.instId==params.instId){var params1={};void 0!==params.type&&"prev"==params.type&&(params1.prev=!0),$scope.loadMoreDir(params1)}}),$scope.loadMoreDir=function(params){var getMoreItemsTrig=!1;params.prev?0===$scope.opts.cursors.items.start&&0!==$scope.opts.cursors.itemsView.start||$scope.opts.cursors.items.start<$scope.opts.cursors.itemsView.start-$attrs.pageSize?changePage({prev:!0}):(getMoreItemsTrig=!0,params.noDelay=!0,getMoreItems({prev:!0})):$scope.opts.cursors.items.end>$scope.opts.cursors.itemsView.end+$attrs.pageSize||$scope.noMoreLoadMoreItems.next&&$scope.opts.cursors.items.end>$scope.opts.cursors.itemsView.end?changePage({next:!0}):(getMoreItemsTrig=!0,params.noDelay=!0,getMoreItems({next:!0}))},init({})}}}]).factory("jrgInfinitescrollData",["$timeout",function(){var inst={data:{},inited:!1,windowScroll:function(instId,data){void 0!==data.callback&&data.callback({})},exists:function(instId){var exists=!1;if(void 0!==this.data[instId]){var eleId=this.data[instId].attrs.ids.scrollContent;document.getElementById(eleId)&&(exists=!0)}return exists},initInst:function(instId,params){params.scrollPos=-1,this.data[instId]=params},destroy:function(instId){void 0!==this.data[instId]&&delete this.data[instId]},removeScrollEvt:function(instId,params){this.destroy(instId,params)},addScrollEvt:function(instId,params){var eleId,thisObj=this;this.inited||(window.onscroll=function(){for(var xx in thisObj.data)eleId=thisObj.data[xx].attrs.ids.scrollContent,document.getElementById(eleId)?thisObj.windowScroll(xx,thisObj.data[xx],{}):thisObj.removeScrollEvt(xx,{})}),this.inited=!0,void 0!==this.data[instId]&&(this.data[instId]=angular.extend(this.data[instId],params))}};return inst}]);